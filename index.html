<!DOCTYPE html>
<html lang="en" data-theme="light">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>BP Share</title>
  <link rel="manifest" href="manifest.webmanifest">
  <meta name="theme-color" content="#1E88E5">

  <!-- Icons -->
  <link rel="icon" type="image/x-icon" href="favicon.ico">
  <link rel="icon" type="image/png" sizes="192x192" href="icons/icon-192.png">
  <link rel="apple-touch-icon" sizes="192x192" href="icons/icon-192.png">
  <link rel="apple-touch-icon" sizes="512x512" href="icons/icon-512.png">

  <style>
    :root{
      --primary:#1E88E5;        /* medical blue */
      --primary-2:#26A69A;      /* teal accent */
      --bg:#F5F7FA;             /* soft grey page */
      --card:#FFFFFF;           /* white card */
      --text:#2C3E50;           /* neutral text */
      --muted:#607D8B;          /* muted labels */
      --border:#E3E8EF;         /* light border */
      --shadow: 0 6px 20px rgba(30,136,229,0.08);
      --radius:14px;
      --grad-btn: linear-gradient(135deg, #1E88E5 0%, #26A69A 100%);
      --grad-header: linear-gradient(90deg, #1E88E5 0%, #26A69A 100%);
      --focus: 0 0 0 3px rgba(30,136,229,0.15);
    }
    /* Future-ready dark mode (disabled by default) */
    :root[data-theme="dark"]{
      --bg:#0b1020; --card:#0f1630; --text:#e9ecf1; --muted:#a5afc9;
      --border: rgba(255,255,255,0.08);
      --shadow: 0 10px 30px rgba(0,0,0,0.35), inset 0 0 0 1px rgba(255,255,255,0.05);
      --focus: 0 0 0 3px rgba(30,136,229,0.25);
    }
    :root[data-theme="dark"] .ghost{ color: #cfe8ff; border-color: rgba(207,232,255,0.5); }
    :root[data-theme="dark"] table{ background: rgba(255,255,255,0.03); }
    :root[data-theme="dark"] thead th{ background: linear-gradient(180deg, rgba(255,255,255,0.08), rgba(255,255,255,0.03)); color:#fff; border-bottom:1px solid var(--border); }
    :root[data-theme="dark"] tbody tr{ border-top:1px solid var(--border); }
    :root[data-theme="dark"] tbody tr:hover{ background: rgba(255,255,255,0.04); }
    :root[data-theme="dark"] input, :root[data-theme="dark"] select, :root[data-theme="dark"] textarea {
      background: rgba(255,255,255,0.04); color: var(--text); border-color: var(--border);
    }

    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0; background:var(--bg); color:var(--text);
      font-family: ui-sans-serif, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Apple Color Emoji","Segoe UI Emoji";
      line-height:1.35;
    }
    .wrap{ width:min(1100px, 94vw); margin: 28px auto; }
    header{
      background: var(--card);
      border:1px solid var(--border);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      padding: 0;
      overflow:hidden;
    }
    .topbar{ height: 8px; background: var(--grad-header); }
    .head-content{
      padding: 16px;
      display:flex; align-items:center; justify-content:space-between; gap:14px;
    }
    .brand{display:flex; align-items:center; gap:12px}
    .logo{ width:38px; height:38px; border-radius:10px; box-shadow: 0 4px 12px rgba(30,136,229,0.25); }
    h1{font-size: clamp(18px, 2.4vw, 22px); margin:0}
    .subtitle{color:var(--muted); font-size:13px}

    button{
      padding:12px 14px; border:0; border-radius:12px; cursor:pointer;
      color:white; font-weight:600; letter-spacing:.2px;
      transition: transform .06s ease, box-shadow .2s ease, opacity .2s ease;
    }
    button:active{ transform: translateY(1px) scale(.995); }
    .primary{ background: var(--grad-btn); box-shadow: 0 8px 22px rgba(30,136,229,0.24); }
    .ghost{ background: transparent; color: var(--primary); border:1px solid var(--primary); }

    .grid{ display:grid; gap:14px; grid-template-columns: repeat(12, 1fr); }
    .card{
      grid-column: 1 / -1;
      background: var(--card);
      border:1px solid var(--border);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      padding: 16px;
    }
    .section-title{ display:flex; align-items:center; justify-content:space-between; gap:10px; margin-bottom:10px; }
    .section-title h2{ margin:0; font-size: clamp(14px, 2vw, 18px); color:#123; }
    .muted{ color:var(--muted); font-size:12px }

    label{ display:block; font-size:12px; color:var(--muted); margin: 6px 0 6px; }
    input, select, textarea{
      width:100%; padding:12px 12px; border-radius:12px;
      border:1px solid var(--border); background:white; color:var(--text); outline:none;
      box-shadow: 0 1px 0 rgba(0,0,0,0.02);
    }
    input:focus, select:focus, textarea:focus{ box-shadow: var(--focus); border-color:#BCD6F5; }
    input::placeholder{ color:#96A4B8; }
    textarea{ min-height: 64px; resize: vertical; }

    .col-6{ grid-column: span 6; }
    .col-4{ grid-column: span 4; }
    .col-12{ grid-column: span 12; }
    @media (max-width: 820px){ .col-6,.col-4{ grid-column: span 12; } }

    table{
      width:100%; border-collapse: collapse; overflow:hidden;
      border-radius: 12px; border:1px solid var(--border); background:white;
    }
    th, td{ padding: 10px 8px; text-align:center; font-size: 13px; }
    thead th{
      background: linear-gradient(180deg, #F5FAFF, #ECF4FF);
      color:#123; font-weight:700; border-bottom:1px solid var(--border);
    }
    tbody tr{ border-top:1px solid var(--border); }
    tbody tr:hover{ background:#FAFDFF; }
    tbody input, tbody select{ background: #FBFDFF; }

    .row-actions{ display:flex; gap:8px; flex-wrap:wrap; }
    footer{ color:var(--muted); font-size:12px; padding: 10px; text-align:center; }
    .helper{display:flex; align-items:center; gap:8px; color:var(--muted); font-size:12px}
    .pill{display:inline-flex; align-items:center; gap:6px; background:#EEF7FF; color:#0F5AB3; border:1px solid #CFE6FF; border-radius:999px; padding:6px 10px; font-size:12px}

    .btn-row{ display:flex; align-items:center; gap:10px; flex-wrap:wrap; }

    /* Splash / Loading Screen */
    #splash{
      position:fixed; inset:0; display:grid; place-items:center; z-index:9999;
      background: linear-gradient(135deg, #1E88E5 0%, #26A69A 100%);
      color:#fff; text-align:center;
      transition: opacity .45s ease, visibility .45s ease;
    }
    #splash.hide{ opacity:0; visibility:hidden; }
    .splash-card{ display:flex; flex-direction:column; align-items:center; gap:14px; }
    .splash-card img{ width:84px; height:84px; border-radius:18px; box-shadow: 0 10px 30px rgba(0,0,0,.25); }
    .splash-title{ font-size:22px; font-weight:700; letter-spacing:.2px; }
    .splash-sub{ font-size:13px; opacity:.9; }
  </style>
</head>
<body>
  <!-- Splash -->
  <div id="splash" aria-label="Loading">
    <div class="splash-card">
      <img src="icons/icon-192.png" alt="BP Share Logo">
      <div class="splash-title">BP Share</div>
      <div class="splash-sub">Preparing your medical tracker…</div>
    </div>
  </div>

  <div class="wrap">
    <header>
      <div class="topbar"></div>
      <div class="head-content">
        <div class="brand">
          <img src="icons/icon-192.png" alt="BP Share Logo" class="logo">
          <div>
            <h1>BP Share</h1>
            <div class="subtitle">Professional summaries for patients’ loved ones</div>
          </div>
        </div>
        <div class="btn-row">
          <button class="ghost" id="installBtn" hidden>Install</button>
          <button class="primary" id="previewBtn">Preview</button>
          <button class="primary" id="exportBtn">Export to PDF</button>
          <button class="primary" id="shareBtn">Share via WhatsApp</button>
        </div>
      </div>
    </header>

    <section class="grid" style="margin-top:14px;">
      <div class="card col-12">
        <div class="section-title">
          <h2>Patient & Summary</h2>
          <span class="pill">HIPAA-friendly text summary</span>
        </div>
        <div class="grid">
          <div class="col-6">
            <label>Patient Name</label>
            <input id="patientName" placeholder="e.g., Jane Doe">
          </div>
          <div class="col-6">
            <label>Date / Week of</label>
            <input id="weekOf" type="date">
          </div>
          <div class="col-4">
            <label>Starting Weight (kg)</label>
            <input id="startWeight" type="number" step="0.1" inputmode="decimal" placeholder="e.g., 70.5">
          </div>
          <div class="col-4">
            <label>Ending Weight (kg)</label>
            <input id="endWeight" type="number" step="0.1" inputmode="decimal" placeholder="e.g., 69.9">
          </div>
          <div class="col-4">
            <label>Recipient WhatsApp Number <span class="muted">(country code + number)</span></label>
            <input id="recipient" placeholder="e.g., 23324XXXXXXX">
          </div>
          <div class="col-12">
            <label>Optional Note</label>
            <textarea id="note" placeholder="e.g., Doctor said to monitor morning & evening."></textarea>
          </div>
        </div>
      </div>

      <div class="card col-12">
        <div class="section-title">
          <h2>Readings</h2>
          <div class="row-actions">
            <button class="ghost" id="addRowBtn">Add Row</button>
            <button class="ghost" id="clearRowsBtn">Clear</button>
          </div>
        </div>
        <div style="overflow:auto;">
          <table id="bpTable">
            <thead>
              <tr>
                <th>Day & Time</th>
                <th>AM/PM</th>
                <th>Heart Rate</th>
                <th>Systolic</th>
                <th>Diastolic</th>
              </tr>
            </thead>
            <tbody></tbody>
          </table>
        </div>
        <div class="helper" style="margin-top:8px;">
          <span>Tip:</span> Use two rows per day (morning & evening) for consistency.
        </div>
      </div>

      <div class="card col-12" style="display:flex; align-items:center; justify-content:space-between; gap:12px;">
        <div class="helper">Preview your message before sharing or exporting.</div>
        <div class="btn-row">
          <button class="primary" id="previewBtn2">Preview</button>
          <button class="primary" id="exportBtn2">Export to PDF</button>
          <button class="primary" id="shareBtn2">Share via WhatsApp</button>
        </div>
      </div>
    </section>

    <footer>Works best in Safari (iPhone) or Chrome (Android). You can install it to your home screen.</footer>
  </div>

  <script>
    // Theme manager (future-ready): defaults to light. To enable dark later, run BPTheme.set('dark')
    (function(){
      try {
        const saved = localStorage.getItem('bp_theme') || 'light';
        document.documentElement.setAttribute('data-theme', saved);
        window.BPTheme = {
          set: (mode) => {
            if (!mode || !/^(light|dark)$/.test(mode)) return;
            localStorage.setItem('bp_theme', mode);
            document.documentElement.setAttribute('data-theme', mode);
          },
          get: () => document.documentElement.getAttribute('data-theme') || 'light'
        };
      } catch (_) {}
    })();

    // Splash hide on load or after a short delay as fallback
    const hideSplash = () => {
      const s = document.getElementById('splash');
      if (s) s.classList.add('hide');
    };
    window.addEventListener('load', () => setTimeout(hideSplash, 400));
    setTimeout(hideSplash, 2000);

    // Install flow
    let deferredPrompt;
    const installBtn = document.getElementById('installBtn');
    window.addEventListener('beforeinstallprompt', (e) => {
      e.preventDefault();
      deferredPrompt = e;
      installBtn.hidden = false;
    });
    installBtn?.addEventListener('click', async () => {
      if (!deferredPrompt) return;
      deferredPrompt.prompt();
      await deferredPrompt.userChoice;
      deferredPrompt = null;
      installBtn.hidden = true;
    });

    // Table helpers
    const tbody = document.querySelector('#bpTable tbody');
    const addRowBtn = document.getElementById('addRowBtn');
    const clearRowsBtn = document.getElementById('clearRowsBtn');

    function addRow(prefill = {}) {
      const tr = document.createElement('tr');

      const tdTime = document.createElement('td');
      const timeInput = document.createElement('input');
      timeInput.placeholder = 'e.g., Mon 08:00';
      timeInput.value = prefill.time || '';
      tdTime.appendChild(timeInput);

      const tdMeridiem = document.createElement('td');
      const sel = document.createElement('select');
      ['AM','PM'].forEach(v => {
        const opt = document.createElement('option');
        opt.value = v; opt.textContent = v;
        sel.appendChild(opt);
      });
      sel.value = prefill.meridiem || 'AM';
      tdMeridiem.appendChild(sel);

      const tdHr = document.createElement('td');
      const hrInput = document.createElement('input');
      hrInput.type = 'number'; hrInput.inputMode = 'numeric';
      hrInput.placeholder = 'bpm'; hrInput.value = prefill.hr || '';
      tdHr.appendChild(hrInput);

      const tdSys = document.createElement('td');
      const sysInput = document.createElement('input');
      sysInput.type = 'number'; sysInput.inputMode = 'numeric';
      sysInput.placeholder = 'mmHg'; sysInput.value = prefill.sys || '';
      tdSys.appendChild(sysInput);

      const tdDia = document.createElement('td');
      const diaInput = document.createElement('input');
      diaInput.type = 'number'; diaInput.inputMode = 'numeric';
      diaInput.placeholder = 'mmHg'; diaInput.value = prefill.dia || '';
      tdDia.appendChild(diaInput);

      tr.append(tdTime, tdMeridiem, tdHr, tdSys, tdDia);
      tbody.appendChild(tr);
    }

    addRowBtn.addEventListener('click', () => addRow());
    clearRowsBtn.addEventListener('click', () => { tbody.innerHTML = ''; });

    // Starter rows
    addRow({time:'Mon 08:00', meridiem:'AM'});
    addRow({time:'Mon 20:00', meridiem:'PM'});

    function collectData() {
      const rows = [];
      tbody.querySelectorAll('tr').forEach(tr => {
        const cells = tr.querySelectorAll('td');
        const timeEl = cells[0].querySelector('input');
        const merEl = cells[1].querySelector('select');
        const hrEl = cells[2].querySelector('input');
        const sysEl = cells[3].querySelector('input');
        const diaEl = cells[4].querySelector('input');
        rows.push({
          time: timeEl?.value.trim() || '',
          meridiem: merEl?.value || '',
          hr: hrEl?.value.trim() || '',
          sys: sysEl?.value.trim() || '',
          dia: diaEl?.value.trim() || ''
        });
      });
      return rows.filter(r => r.time || r.hr || r.sys || r.dia);
    }

    function buildMessage() {
      const name = document.getElementById('patientName').value.trim();
      const weekOf = document.getElementById('weekOf').value;
      const startW = document.getElementById('startWeight').value.trim();
      const endW = document.getElementById('endWeight').value.trim();
      const note = document.getElementById('note').value.trim();
      const readings = collectData();

      let lines = [];
      lines.push(name ? `BP Update for ${name}` : `BP Update`);
      if (weekOf) lines.push(`Date/Week: ${weekOf}`);
      if (startW || endW) lines.push(`Weight: ${startW || '-'} → ${endW || '-'}`);
      if (note) lines.push(`Note: ${note}`);
      lines.push("");
      if (readings.length) {
        lines.push("Readings (time AM/PM | HR | SYS/DIA):");
        readings.forEach(r => {
          lines.push(`${r.time || '-'} ${r.meridiem || '-'} | ${r.hr || '-'} | ${r.sys || '-'}/${r.dia || '-'}`);
        });
      } else {
        lines.push("No readings entered yet.");
      }
      lines.push("");
      lines.push("— Sent from BP Share");
      return lines.join("\n");
    }

    function doPreview(){
      const msg = buildMessage();
      const pre = document.createElement('pre');
      pre.textContent = msg;
      pre.style.whiteSpace = 'pre-wrap';
      const dlg = document.createElement('div');
      dlg.style.position='fixed'; dlg.style.inset='0'; dlg.style.display='grid'; dlg.style.placeItems='center';
      dlg.style.background='rgba(0,0,0,.28)';
      dlg.innerHTML = '<div style="max-width:720px;width:92vw;background:var(--card);border:1px solid var(--border);border-radius:16px;box-shadow:var(--shadow);padding:16px;"><div style="display:flex;justify-content:space-between;align-items:center;gap:12px;margin-bottom:8px;"><strong>Message Preview</strong><button id="closeDlg" class="ghost" style="color:#1E88E5;border-color:#1E88E5;background:transparent;padding:8px 10px;border:1px solid #1E88E5;border-radius:10px;">Close</button></div></div>';
      dlg.querySelector('div').appendChild(pre);
      document.body.appendChild(dlg);
      dlg.querySelector('#closeDlg').onclick=()=>dlg.remove();
    }

    function doExportPDF(){
      const name = document.getElementById('patientName').value.trim() || 'Patient';
      const weekOf = document.getElementById('weekOf').value || '';
      const startW = document.getElementById('startWeight').value.trim();
      const endW = document.getElementById('endWeight').value.trim();
      const note = document.getElementById('note').value.trim();
      const rows = collectData();

      const win = window.open('', '_blank');
      const styles = `
        <style>
          body{ font-family: -apple-system, Segoe UI, Roboto, Helvetica, Arial, sans-serif; margin:24px; color:#1e293b; }
          h1{ font-size:20px; margin:0 0 4px 0; }
          .sub{ color:#475569; margin-bottom:16px; }
          table{ width:100%; border-collapse:collapse; }
          th,td{ border:1px solid #cbd5e1; padding:8px; text-align:center; font-size:12px; }
          thead th{ background:#f1f5f9; }
          .meta{ margin:12px 0; font-size:14px; }
          .note{ margin-top:10px; font-size:13px; color:#334155; }
          @media print { @page { size: A4 portrait; margin: 16mm; } }
        </style>`;

      const header = `<h1>Blood Pressure – Weekly Summary</h1>
        <div class="sub">${name}${weekOf ? ' • Week of ' + weekOf : ''}</div>
        <div class="meta">Weight: ${startW || '-'} → ${endW || '-'}</div>
        ${note ? `<div class="note"><strong>Note:</strong> ${note}</div>` : ''}`;

      const rowsHtml = rows.map(r => `<tr>
        <td>${r.time || ''}</td>
        <td>${r.meridiem || ''}</td>
        <td>${r.hr || ''}</td>
        <td>${r.sys || ''}</td>
        <td>${r.dia || ''}</td>
      </tr>`).join('');

      const table = `<table>
        <thead><tr>
          <th>Day & Time</th><th>AM/PM</th><th>Heart Rate</th><th>Systolic</th><th>Diastolic</th>
        </tr></thead>
        <tbody>${rowsHtml || '<tr><td colspan="5">No readings</td></tr>'}</tbody>
      </table>`;

      win.document.write(`<!doctype html><html><head><meta charset="utf-8">${styles}</head><body>${header}${table}</body></html>`);
      win.document.close();
      win.focus();
      setTimeout(() => { win.print(); }, 300);
    }

    function doShare(){
      const msg = buildMessage();
      const recipient = document.getElementById('recipient').value.replace(/\D/g, '');
      if (navigator.share) {
        navigator.share({ text: msg }).catch(()=>{
          const base = recipient ? `https://wa.me/${recipient}` : `https://wa.me/`;
          const url = base + `?text=` + encodeURIComponent(msg);
          window.location.href = url;
        });
      } else {
        const base = recipient ? `https://wa.me/${recipient}` : `https://wa.me/`;
        const url = base + `?text=` + encodeURIComponent(msg);
        window.location.href = url;
      }
    }

    document.getElementById('previewBtn').addEventListener('click', doPreview);
    document.getElementById('previewBtn2')?.addEventListener('click', doPreview);
    document.getElementById('exportBtn').addEventListener('click', doExportPDF);
    document.getElementById('exportBtn2')?.addEventListener('click', doExportPDF);
    document.getElementById('shareBtn').addEventListener('click', doShare);
    document.getElementById('shareBtn2')?.addEventListener('click', doShare);

    // Register service worker (kept at end so splash fades out first)
    if ('serviceWorker' in navigator) {
      window.addEventListener('load', () => {
        navigator.serviceWorker.register('./service-worker.js');
      });
    }
  </script>
</body>
</html>
